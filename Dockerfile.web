# Dockerfile for Budget Sync Web Frontend
#
# Builds the Next.js frontend in standalone mode.
# Uses Next.js rewrites to proxy GraphQL requests to the backend service.
#
# Build:
#   docker build -f Dockerfile.web \
#     --build-arg NEXT_PUBLIC_ALLOWED_EMAIL=your@email.com \
#     --build-arg NEXT_PUBLIC_ALLOWED_PASSWORD=secret \
#     --build-arg API_URL=https://webhook-xxxxx.run.app \
#     -t budget-sync-web .
#
# Run:
#   docker run --rm -p 3000:3000 budget-sync-web

# ========================================
# Stage 1: Install dependencies
# ========================================
FROM oven/bun:1 AS deps

WORKDIR /app/web

COPY web/package.json web/bun.lock ./
RUN bun install --frozen-lockfile --ignore-scripts

# ========================================
# Stage 2: Build Next.js
# ========================================
FROM oven/bun:1 AS builder

WORKDIR /app

# Copy backend schema files (needed for GraphQL codegen)
COPY src/presentation/graphql/schema ./src/presentation/graphql/schema

# Copy frontend source
COPY web ./web
COPY --from=deps /app/web/node_modules ./web/node_modules

WORKDIR /app/web

# Run GraphQL codegen
RUN bun run codegen

# Build args for auth and API URL (baked into build)
ARG NEXT_PUBLIC_ALLOWED_EMAIL
ARG NEXT_PUBLIC_ALLOWED_PASSWORD
ARG API_URL

# Set environment variables for build
ENV NEXT_PUBLIC_ALLOWED_EMAIL=${NEXT_PUBLIC_ALLOWED_EMAIL}
ENV NEXT_PUBLIC_ALLOWED_PASSWORD=${NEXT_PUBLIC_ALLOWED_PASSWORD}
ENV API_URL=${API_URL}

# Build Next.js with standalone output
RUN bun run build

# ========================================
# Stage 3: Production runtime
# ========================================
FROM node:22-alpine AS runtime

WORKDIR /app

# Create non-root user for security
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup

# Copy Next.js standalone output
COPY --from=builder /app/web/.next/standalone ./
COPY --from=builder /app/web/.next/static ./web/.next/static
COPY --from=builder /app/web/public ./web/public

# Set ownership
RUN chown -R appuser:appgroup /app

USER appuser

# Expose Next.js port
EXPOSE 3000

# Set hostname for Cloud Run
ENV HOSTNAME="0.0.0.0"
ENV PORT="3000"

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD wget -q --spider http://localhost:3000/ || exit 1

# Run Next.js standalone server
CMD ["node", "web/server.js"]
